#!title:    MP3音频编码研究笔记
#!date:     2019-11-03
#!authors:  Mikukonai
#!cover:    
#!type:     M
#!tags:     

#!{ImagePath}:./image/assets/M/mp3

#!content

# 比特储备机制（20191224）

一言以蔽之，比特储备（bit reservoir）机制可以在恒定码率（CBR）的前提下，允许帧长度在一定的范围内弹性地变动。这样，既能保证比特流的码率不变（从而方便地实现定位、裁剪等处理），又可以赋予比较“复杂”的音频帧以足够的编码空间额度，保证编码质量。

在介绍比特储备机制之前，有必要介绍一些前置知识。

## MP3比特流结构

如无说明，以下只考虑CBR模式。因为只有CBR模式才需要用到比特储备机制。

MP3比特流是由一连串的帧（frame）构成的。每个帧的结构如下图。

![ ](./image/assets/M/mp3-frame.png)

图中Header是帧头，描述了比特率、采样率、声道数等基本信息。之所以每一帧都要带上这些信息，一方面是应用场景决定的，比如流媒体、实时通信场景，一般不会事先约定这些信息。另一方面是对于VBR模式，每一帧的实际码率都可能不一样，因此需要单独声明。

Header的开头是连续12个1组成的同步字。解码器在比特流中搜索同步字，以得到一帧的开头。在某些极端情形下，在不是帧开头的位置上也可能出现连续12个（或以上的）1，这一般是由于辅助信息的格式设计不当，因此11172标准中特别提醒，尽量不要在辅助信息中出现同步字，妨碍帧头的定位。标准规定的哈夫曼码表不会出现连续12个或以上的1。

CRC是循环冗余校验码，可有可无。

Header和CRC在MP3比特流中的位置是固定的，这有利于比特流的定位（同步）。连续两个帧头的间距frameLength为（单位bits）

```
frameLength = (bitRate * 1152) / sampleRate + (paddingSlot * 8)
```

在44100Hz采样率下，计算出来的间距是小数。因此为了保证码率不会因为小数部分的偏差而漂移，需要在个别帧中插入额外的填充字节，以抵消累积的误差。以320kbps/44100Hz举例，按照上面的公式，每帧长度约为1044.9字节，而帧的长度只能是整数个字节[注]。如果采用1044作为帧长度，那么若干个帧累积起来，就会有相当可观的误差——实际码率小于320kbps。因此，每隔几个帧，就有一个长度为1045字节的帧，以抵消每帧0.9字节的短少累积起来的总的码率误差。这与历法置闰非常类似。

> **注**：MPEG-1规定的是帧头之间的「槽」（slot）数相等，且 Layer 3 每个槽长度为1个字节，因此说“帧的长度必须为整数个字节”。

式中1152代表每帧有1152个时域（频域）采样点。这是标准规定的常数，所有编解码算法的参数（例如窗口大小等）都取决于这个数。

每帧1152采样点被分为两个granule（颗粒，或者称子帧，下文直接用英文指称之），每个granule有576个采样点。granule是编码的最小单位。由于音频分帧相当于截断，因此为了避免截断带来的噪声，需要对相邻帧作50%的重叠。使用考虑重叠的改进的DCT（即MDCT）对时域数据进行处理，输入是经重叠的2n个点，输出是n个点。因此MP3设定每帧1152点包含2个576点的granule，无论是子带滤波还是量化、熵编码，都是以granule为最小的编码单位。解码时，可从576点的granule经过IMDCT恢复出1152点的时域帧，经重叠-相加算法即可恢复出分帧前的信号。

由于帧头间隔由码率和采样率决定，因此可以认为是平均帧长。鉴于每帧有2个granule，因此每个granule的平均长度就等于平均帧长的一半，且仅由采样率和码率（以及声道数和是否“置闰”）决定。

实际编码后的granule的码长往往少于平均长度，但也有比平均长度长的情况出现。这与granule自身的性质有关，将在下文介绍。

图中竖直的红线代表 MainData 的起始点，之所以特别标注，是因为这个起始点一般位于本帧帧头的前面，也就是上一帧的位置。MainData起始点距离边信息SideInfo结束位置的向左的偏移量（字节），记录在边信息的main_data_begin字段，其最大值为511，意味着MainData最多偏移511字节。这个偏移量的确定方法，就是本文所讲的比特储备机制。

![ ](./image/assets/M/mp3-main-data-begin.png)

## 量化与熵编码

量化和熵编码模块是MP3编码的核心之一，具体算法按下不表，这里只需要知道：主控喂给此模块一个576点的频域granule，同时指定编码长度的“预算”，此模块就可以给出granule的二进制编码，并保证其长度不超过预算。

每个granule分配多少码长预算，取决于比特储备的余量，以及其自身的“复杂”程度。具体的分配机制是本文的核心，这个放在后面讲，现在来简单介绍一下，如何衡量granule的“复杂”程度。

音频信号的“复杂”程度是不同的。直观上可以这样理解：例如大镲的声音在各个频率上都有比较强的成分，而钢琴的声音只在离散的几个泛音上比较强，且越往高频越弱，所以编码大镲的声音所耗费的比特数，要多于钢琴。

每个granule的“复杂”程度，由感知熵（PE）衡量。感知熵由编码器的心理声学模型（PAM）计算得到，它衡量一个granule在不产生人耳可闻噪声的前提下，能够压缩到的信息量下限。PE乘以3.1，就是一个granule不产生可闻失真的压缩编码长度下限（单位bit），下文称“最小无噪压缩码长”。

在128kpbs及以上的码率下，常见的音乐信号中只有少数（320kbps下往往不足一成）granule的最小无噪压缩码长比平均码长要大，绝大多数granule的最小无噪压缩码长都不会超过平均码长。

# 待整理的笔记

## 分析子带滤波器组（20191104）

分析子带滤波器组，用于编码器。

首先明确输入和输出形式。对于每帧1152采样，划分成36组长度为32点的采样段，将每段**分别**输入滤波器，执行36次32点子带滤波，得到长度为32的滤波后结果。则36个采样段可以得到36组长度为32的滤波后结果。

滤波后结果的每一点对应32个子带之一，所以换一个视角，子带滤波器组的输出结果是：32个长度为36的子带滤波结果，每个结果对应一个频带。

至于子带滤波器，它的信号流图以及算法参数都在11172标准中有定义，直接照抄就可以。

## 心理声学模型如何控制码率分配（20191105）

+ 量化会引入量化噪声，包括同时噪声，也包括前回声（尤其是长窗口MDCT情况下）。
+ 人耳存在掩蔽效应，凡是低于掩蔽门限的声音，都是无法察觉的。掩蔽信号（Masker）与其某个掩蔽门限之比，称为信掩比（SMR）。
+ 量化位数越多，精度越高，量化噪声越低，即信噪比（SNR）越高，代价是码率开销越大。
+ 因此，对于某个信号，在某个量化精度下，如果其量化噪声恰好低于掩蔽门限，则量化噪声无法察觉，那么此时的量化精度就刚刚好，再提高量化精度也没有感知上的意义了。
+ 定义掩噪比MNR=SNR-SMR（标准如此），显然，如果某个量化位数使得MNR等于0，则此量化位数就是能够不引起可察觉量化失真的最低位数。
+ 编码器通过内部的循环，确定每帧的最佳量化位数，以实现VBR。

## 20191217

> 这次研究MP3编解码算法，从11月初开始到现在已经有一个半月，进度还是很快的。
总结了Scheme解释器开发的经验教训，这次从一开始就有比较客观、宽松的心理预期，做好了打持久战的准备。
比较深刻的感受是自己的工程能力确实不行。越是到精深微妙之处，越感觉自己在驾驭复杂的系统上捉襟见肘、顾此失彼，更遑论优化和规范了。
工程的事情，经验很重要。做过和没做过，完全不一样。MP3编码器这个东西，不是个小东西。dist10编码器部分有1万多行C，自己实现的截至目前大概有2千行有效js代码。客观地说，它门槛不低，一方面是算法上的复杂性，光是信号与系统的知识就足以劝退大多数人；另一方面是工程上的复杂性，因为是底层技术，它本身就是一个库，所以要亲手处理很多细节问题。这都是很大的挑战。
那么做这件事的价值是什么呢，有很多方面。能对一个项目保持一个多月的稳定的学习输入，对我来说算是比较难得，根本原因在于兴趣。一直对音频技术感兴趣。所以第一个价值就是满足好奇心，做一个编码器出来也算是给自己一个交代。第二个价值就是功利方面的，我觉得这东西是足够牛逼，足够硬核，足够写进简历的。并且，音视频这个领域我觉得未来还是会有比较重要的地位。
一点简单的复盘，希望我能坚持做完这件事。

## 20191217

> 昨晚爆肝一夜，把噪声控制循环做完了。
预加重暂时不做，混合块模式不打算做。
用EncSpot观察了一些MP3文件的详细信息，发现几乎所有现有的文件里，长块都占97%以上，短块极少，混合块想必更少了。
验证计划：Hybrid filterbank 是无副作用的模块，其结果是相对值得信赖的。量化循环则比较复杂，也是最不靠谱的部分。所以解码器部分，除了已经基本完成的哈夫曼解码、频谱重排之外，反量化、前端也要做一下，验证MDCT输出的结果在编解码后是否一致就可以了。长块短块都要验证。
还有PAM2，照葫芦画瓢是可以实现的，目前看来没什么实现上的难度。PAM2算是比较紧迫的需求，因为现在对噪声容限的值没有任何直观概念，不利于调试。
比特池（所谓的reservoir）目前不理解，需要研究dist10源码。
scfsi放在最后实现，可以直接抄dist10。重在理解原理。
最后要强调一点就是MVP导向的开发，可视化是一定要有的。代码即文档。

## 关于比特储备机制的理解（20191223）

> 比特储备池派发（make available）的比特数，再加上mean_bits，即为量化循环可用的比特数（max_bits）。
之前一直没搞明白这个因果关系：是比特储备池给量化循环派发比特额度，然后量化循环去利用这个额度，而不是反过来。
然后，量化循环完成后，一般都会剩下一些没有用完的额度，这个剩余的额度就会捐献给比特储备池。
如果一顿操作后，比特储备池还是超过了可用容量，那么就需要给量化完的Granule增加填充比特，这实际上是修改Granule的part23Length，同时比特储备池的容量会相应地减少，恢复到正常容量。

# 研究动机和目标

MP3音频编码标准，自从上个世纪80年代末提出至今，已经有三十余年的历史了。MP3是第一个针对“宽带”音频的压缩编码标准，在此之前的技术大多是针对语音压缩而提出的。MP3发展至今，已经一统江湖，成为最流行的数字音频压缩标准，没有之一；“MP3”这个词，俨然成为数字音乐的代名词。由于我本人对于音响技术一直很感兴趣，再加上近期知识管理工作中对于MP3文件管理的客观需要，都需要对MP3编解码原理做一些深入的研究，直至实现最基本的编解码器原型。

MP3编码标准所使用的技术，包括子带滤波、心理声学模型、变换编码和熵编码，都是非常具有代表性的技术，横跨众多领域，奠定了众多后续技术的基础。包括AAC、AC-3、MP3Pro等更为先进的音频编解码技术，都与MP3有着类似的思路。因此，掌握MP3标准之后再学习其他更为先进的标准，就轻松多了。

经过这段时间的研究，我的观念有所变化。那就是在个人数据管理工作中，一味追求无损是没有意义的。无损PCM相比于320K的MP3，并不会带来多高的音质提升，却浪费了几倍的空间，实在是不值当。这与高清视频不同：大尺寸、高帧率、高位深，是肉眼能实实在在感受到的。所以，以后不必一味追求PCM无损，省下来的空间多保存一些4K乃至8K的超高清视频，这是更划算的。

# MP3标准概述

全称 MPEG-1 Layer Ⅲ，对应国际标准为 ISO/IEC 11172-3。

![MP3编码器框图]({ImagePath}/mp3-encoder-diagram.png)

![MP3量化循环]({ImagePath}/mp3-qloop.png)

# 心理声学模型

![等响度曲线 \[C2\]](./image/assets/M/equal-loudness-curves.png)

![频域（同时）掩蔽，以及NMR、SNR、SMR之间的关系示意 \[A3\]\(由\[B1\]重制\)]({ImagePath}/mp3-simultaneous-masking.png)

![时域掩蔽 \[A3\]\(由\[B1\]重制\)]({ImagePath}/mp3-temporal-masking.png)


# 滤波与变换编码

子带滤波器组，改进的离散余弦变换（MDCT），长窗口和短窗口，前回声抑制

![分析子带滤波器组的频率特性 [B1]]({ImagePath}/mp3-filterbank.png)

![MDCT使用的四种窗口 [B1]]({ImagePath}/mp3-MDCT-windows.png)

![混叠消除的蝴蝶结运算 [A1]]({ImagePath}/mp3-aliasing-butterfly.png)

# 量化与熵编码

非均匀量化，Huffman编码

# 编码参数与码率控制

CBR/ABR/VBR，码率控制环路

# 比特流结构

ID3v2等

# 现有的编解码器产品

LAME / dist10 / mpg123

# 附录

## WAV文件格式

WAVE文件格式是RIFF格式的其中一种，一般用来存储PCM音频数据，也可以存储其他格式。以下是典型的WAV文件布局。

![WAV文件格式]({ImagePath}/wav-format.png)

- 标红的部分是固定不变的部分。
- 所有数值字段均为小端模式，即高位字节在高地址，低位字节在低地址。
- 格式块字节数：指的是fmt块（蓝色）除了前两个字段以外的其余部分的字节数，固定为16。
- 音频格式：固定为1，代表PCM。
- 声道数：1为单声道；2为双声道。
- 采样率：指每秒钟PCM采样数。
- 每秒字节数：等于采样率×每个采样的字节数。
- 采样字节数：每个采样的字节数，包含所有声道，等于采样位深×声道数÷8。
- 采样位深：每个声道每个采样的位数，一般为8、16。
- 数据块字节数：即所有PCM数据的总的字节数。
- 0x24处可能有一可选块“fact”，PCM格式中一般不会出现。

# 参考资料

**说明**：首先推荐一个MP3资料收集网站，有许多论文和技术资料可供下载：[http://www.mp3-tech.org/]()。以下参考资料中，凡是此网站有收录，或者很容易找到的，不再给出链接；不太容易找到的，将给出链接，方便读者溯源。部分文献资料可联系本文作者索取。

标准文档及其相关解读，标准文档当然是最高依据：

- A1 / **ISO/IEC 11172** - Coding Of Moving Picture And Associated Audio For Digital Storage Media At Up To About 1.5 Mbit/s - Part 3: Audio
- A2 / Pan D . **Tutorial on MPEG/audio compression**[J]. IEEE Multimedia, 1995, 2(2):60-74.
- A3 / Noll, P. [**MPEG digital audio coding**](https://www.csd.uoc.gr/~hy438/lectures/MPEGAudioCoding.pdf)[J]. IEEE Signal Process Mag, 1997, 14(5):59-81.
- A4 / Raissi R. **The theory behind MP3**[J]. MP3’Tech, 2002.

较好的中文论文，原理与实现并重，可供快速入门：

- B1 / 張芷燕. **MP3編碼法之研究與實現**[D]. 国立交通大学（台湾省）, 2002.

有关心理声学和感知编码的文章，可供参考：

- C1 / Painter T, Spanias A. **Perceptual coding of digital audio**[J]. Proceedings of the IEEE, 2000, 88(4): 451-515.
- C2 / Robinson D J M. **The human auditory system**[C]//107th convention of the Audio Engineering Society. 1999: 1-13.

