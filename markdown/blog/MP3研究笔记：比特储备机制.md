#!title:    MP3研究笔记：比特储备机制
#!date:     2019-12-24
#!authors:  Mikukonai
#!cover:    
#!type:     原创
#!tags:     

#!content

# 1 是什么

一言以蔽之，比特储备（bit reservoir）机制可以在恒定码率（CBR）的前提下，允许帧长度在一定的范围内弹性地变动。这样，既能保证比特流的码率不变（从而方便地实现定位、裁剪等处理），又可以赋予比较“复杂”的音频帧以足够的编码空间额度，保证编码质量。

# 2 怎么做

在介绍比特储备机制之前，有必要介绍一些前置知识。

## 2.1 MP3比特流结构

如无说明，以下只考虑CBR模式。因为只有CBR模式才需要用到比特储备机制。

MP3比特流是由一连串的帧（frame）构成的。每个帧的结构如下图。

![ ](./image/wiki/M/mp3-frame.png)

图中Header是帧头，描述了比特率、采样率、声道数等基本信息。之所以每一帧都要带上这些信息，一方面是应用场景决定的，比如流媒体、实时通信场景，一般不会事先约定这些信息。另一方面是对于VBR模式，每一帧的实际码率都可能不一样，因此需要单独声明。

Header的开头是连续12个1组成的同步字。解码器在比特流中搜索同步字，以得到一帧的开头。在某些极端情形下，在不是帧开头的位置上也可能出现连续12个（或以上的）1，这一般是由于辅助信息的格式设计不当，因此11172标准中特别提醒，尽量不要在辅助信息中出现同步字，妨碍帧头的定位。标准规定的哈夫曼码表不会出现连续12个或以上的1。

CRC是循环冗余校验码，可有可无。

Header和CRC在MP3比特流中的位置是固定的，这有利于比特流的定位（同步）。连续两个帧头的间距frameLength为（单位bits）

```
frameLength = (bitRate * 1152) / sampleRate + (paddingSlot * 8)
```

在44100Hz采样率下，计算出来的间距是小数。因此为了保证码率不会因为小数部分的偏差而漂移，需要在个别帧中插入额外的填充字节，以抵消累积的误差。以320kbps/44100Hz举例，按照上面的公式，每帧长度约为1044.9字节，而帧的长度只能是整数个字节[注]。如果采用1044作为帧长度，那么若干个帧累积起来，就会有相当可观的误差——实际码率小于320kbps。因此，每隔几个帧，就有一个长度为1045字节的帧，以抵消每帧0.9字节的短少累积起来的总的码率误差。这与历法置闰非常类似。

> **注**：MPEG-1规定的是帧头之间的「槽」（slot）数相等，且 Layer 3 每个槽长度为1个字节，因此说“帧的长度必须为整数个字节”。

式中1152代表每帧有1152个时域（频域）采样点。这是标准规定的常数，所有编解码算法的参数（例如窗口大小等）都取决于这个数。

每帧1152采样点被分为两个granule（颗粒，或者称子帧，下文直接用英文指称之），每个granule有576个采样点。granule是编码的最小单位。由于音频分帧相当于截断，因此为了避免截断带来的噪声，需要对相邻帧作50%的重叠。使用考虑重叠的改进的DCT（即MDCT）对时域数据进行处理，输入是经重叠的2n个点，输出是n个点。因此MP3设定每帧1152点包含2个576点的granule，无论是子带滤波还是量化、熵编码，都是以granule为最小的编码单位。解码时，可从576点的granule经过IMDCT恢复出1152点的时域帧，经重叠-相加算法即可恢复出分帧前的信号。

由于帧头间隔由码率和采样率决定，因此可以认为是平均帧长。鉴于每帧有2个granule，因此每个granule的平均长度就等于平均帧长的一半，且仅由采样率和码率（以及声道数和是否“置闰”）决定。

实际编码后的granule的码长往往少于平均长度，但也有比平均长度长的情况出现。这与granule自身的性质有关，将在下文介绍。

图中竖直的红线代表 MainData 的起始点，之所以特别标注，是因为这个起始点一般位于本帧帧头的前面，也就是上一帧的位置。MainData起始点距离边信息SideInfo结束位置的向左的偏移量（字节），记录在边信息的main_data_begin字段，其最大值为511，意味着MainData最多偏移511字节。这个偏移量的确定方法，就是本文所讲的比特储备机制。

![ ](./image/wiki/M/mp3-main-data-begin.png)

## 2.2 量化与熵编码

量化和熵编码模块是MP3编码的核心之一，具体算法按下不表，这里只需要知道：主控喂给此模块一个576点的频域granule，同时指定编码长度的“预算”，此模块就可以给出granule的二进制编码，并保证其长度不超过预算。

每个granule分配多少码长预算，取决于比特储备的余量，以及其自身的“复杂”程度。具体的分配机制是本文的核心，这个放在后面讲，现在来简单介绍一下，如何衡量granule的“复杂”程度。

音频信号的“复杂”程度是不同的。直观上可以这样理解：例如大镲的声音在各个频率上都有比较强的成分，而钢琴的声音只在离散的几个泛音上比较强，且越往高频越弱，所以编码大镲的声音所耗费的比特数，要多于钢琴。

每个granule的“复杂”程度，由感知熵（PE）衡量。感知熵由编码器的心理声学模型（PAM）计算得到，它衡量一个granule在不产生人耳可闻噪声的前提下，能够压缩到的信息量下限。PE乘以3.1，就是一个granule不产生可闻失真的压缩编码长度下限（单位bit），下文称“最小无噪压缩码长”。

在128kpbs及以上的码率下，常见的音乐信号中只有少数（320kbps下往往不足一成）granule的最小无噪压缩码长比平均码长要大，绝大多数granule的最小无噪压缩码长都不会超过平均码长。