
#!title:    节拍速度BPM计算
#!date:     2018-11-30
#!authors:  Mikukonai
#!cover:    ./image/cover/52498633_p0.jpg
#!type:     原创
#!tags:     音乐

#!content

这篇文章有待完善。

目前的实现：[BPM-Analyser](https://github.com/mikukonai/BPM-Analyser)

# 自相关函数算法

: <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=298 height=52 src="https://music.163.com/outchain/player?type=2&id=4934355&auto=0&height=32"></iframe>

测试用曲：黒翼は～と，其BPM为100。数据显式地写在本页源代码中（js变量`const kurotsubasa`），其参数如下：

|参数|值|
|-------|
|采样率|44100Hz|
|采样起点|全曲约1/4处|
|帧宽|1024点|
|帧重叠|无|
|帧数|1024帧|
|能量算法|采样对数平方积分|
|时长|23.777s|
|BPM范围|0~1292|

算法：

+ 从原曲1/4长度开始，对原始PCM采样进行分帧。
+ 对每一帧计算能量，计算方法为$E = \sum_{i \in [0,FrameLength)}{ (\log_{10}{sample_i})^2}$
+ 得到长度为1024的能量值序列。
+ 计算能量值序列的自相关序列。
+ 到这一步，就可以通过数序列上的小突起的数目来计算BPM，但是这样做不够自动化，所以继续处理。
+ 对自相关序列做FFT，去掉直流分量后IFFT回去，得到不含直流偏置的自相关序列，此时的自相关序列呈现出明显的周期性。
+ 为了求出这个周期，对其再做一次FFT，得到频谱。
+ 由于自相关序列的频率和原始信号的频率是一致的，而原始的能量值序列的采样率是2584BPM，故自相关序列的“采样率”也是2584BPM。
+ 根据采样定理，频谱宽度为1292BPM。
+ 计算出频谱峰值所在的位置，按比例与1292进行换算，即可得到BPM值。

# 两次FFT的算法（2015）

## 缘起

2015年，折腾过一段时间的Vocaloid。调曲子之前，首先要知道曲子的速度，也就是BPM值。BPM是“拍每分钟”的简写，即一分钟内有多少拍。一般来说，可以用手动计时打拍子的方式来计算BPM。但那时正在学习信号与系统这门课程，于是就想用程序实现。

当时用星之所在、黑翼之心等两三首曲子测试，效果还不错。但由于方案非常粗糙，在一些节奏不那么分明的曲子上，结果就很离谱了，后来就没有再继续研究下去。昨天突然想到这个东西，所以今天重新安装了VS2008，用20多首曲子重新测了一下，写成这篇文章，简单记录一下结果。

## 算法与实现

![星の在り処 频谱](./image/assets/M/hoshinoarika-spectrum.png)

其实一句话就够了……就是对声谱图求一次频谱，取最值点对应的频率为BPM结果。

算法的输入是WAV格式（无压缩PCM）的音频文件，推荐参数如下（其他的没测过）

- 采样率：44100Hz
- 位深：16bit
- 声道数：2

程序解析出采样率、位深等关键参数之后，从音频原长约1/4处开始读取PCM采样点，分别对L、R、LR取平均三个声道分帧、求频谱。

若帧宽1024点，在采样率为44100Hz情况下，每一帧时长为23ms左右。连续取2048帧的频谱（长度约47ms），对每一帧的频谱求取能量，得到能量-时间谱。

对能量-时间谱作FFT，取最值点所在位置对应的实际频率，经换算得到BPM。

总的来说，这种思路是基于一个很简单的假设，即通过音量的强弱变化频率，来确定音乐的速度。

看上面的频谱，是不是有很明显的节奏？大概就是这样。不过这里实现的思路还是太粗糙了一点，只是简单地对每一帧的频谱做积分，而丢失了频谱分布的信息。频谱分布应该是特别重要的，例如规律出现的、在所有频段均匀分布的噪音，可以认为是铜片乐器的声音，这是重要的节奏特征。低频的律动往往代表鼓等打击乐器奠定的基础节奏，都是非常重要的信息。

自相关函数可以提取出随机序列中隐含的周期性信息，因而可以用来解决这个问题。
