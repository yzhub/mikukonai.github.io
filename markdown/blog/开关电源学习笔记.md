#!title:    开关电源学习笔记
#!date:     2020-03-01
#!authors:  Mikukonai
#!cover:    ./image/cover/71334405.jpg
#!type:     
#!tags:     

#!content

对于开关电源的兴趣，是从去年（2019年）购买电脑时研究主板多相供电原理开始的。

# 第一篇 产品·行业

## 商品充电器测评

简单测量了手上现有的几款充电器，数据如下：

| 型号与规格 |体积<br>(cm<sup>3</sup>)|质量<br>(g)|密度<br>(g/cm<sup>3</sup>)|体积能量密度<br>(W/cm<sup>3</sup>)|质量能量密度<br>(W/g)|
|----------------------------------------------------------------------------|
|小米GaN<br>65W快充   | 53.8 | 83.8 | 1.56 | 1.21 | 0.78 |
|小米CC9P自带<br>30W快充 | 72.4 | 84.5 | 1.17 | 0.41 | 0.36 |
|小米6X自带<br>10W 5V 2A | 26.5 | 29.2 | 1.10 | 0.38 | 0.34 |
|苹果小方块<br>5W 5V 1A  | 19.7 | 26.0 | 1.32 | 0.25 | 0.19 |
|中兴自带<br>5W 5V 1A    | 27.8 | 27.5 | 0.99 | 0.18 | 0.18 |
|杂牌<br>15W 5V 3A       | 75.6 | 48.3 | 0.64 | 0.20 | 0.31 |

因为没有协议诱骗器等比较专业的评测设备，所以仅能做一些十分粗糙的比较：

- 小米氮化镓充电器的能量密度显然是最高的，优势极为明显。
- 小米氮化镓充电器的密度也是最高的，手感沉甸甸。
- 其余两款小米充电器的能量密度也比较高，因为是比较新的产品。
- 苹果的小方块尽管能量密度并不是很高，但是它的体积是最小的，密度也相当大。从网上的拆解可以看到，内部做工极为精细紧凑。
- 接口方面，仅2020年的小米氮化镓是Type-C接口，其余的都是祖传的Type-A。小米30W快充的Type-A有一根额外的插针，应该是快充握手用的。另外快充Type-A的两根电源引脚都做了加宽处理，以便通过更大的电流。
- 杂牌电源没有标注3C认证等安全认证标志，更没有厂牌、执行标准等重要的信息，因此为安全起见，今后这类电源一概不许使用。
- 一般来说，能量密度越高，价格越贵。小米氮化镓售价150元，这个价格在同等档次的电源里是最便宜的。

## 小米氮化镓充电器信息汇总

- 2020年2月13日，线上发布会发布
- 附带线材规格：100W 5A E-marker USB2.0
- 快充协议支持：PD、BC1.2、Apple2.4A、AFC、FCP、QC3.0 ClassB（最大电压20V）[B5]
- PD协议支持5V/3A、9V/3A、12V/3A、15V/3A、20V/3.25A五档固定电压档位，以及5-11V/3A、5-20V/3.2A两档PPS电压档位。[B5]
- 功率开关：纳微半导体NV6115和NV6117，内置驱动器和控制电路，170mΩ/120mΩ导阻，耐压650V，支持2MHz开关频率，采用5*6mm QFN封装，节省面积。[B5]
- PWM控制器：安森美NCP51530B。[B5]
- 快充协议芯片：赛普拉斯CYPD3174。[B5]
- 初级控制器：德仪UCC28780，工作频率可达1MHz，支持GaN功率管，内置多种保护功能。[B5]
- 同步整流控制器：MPS芯源半导体MP6908。
- 次级同步整流MOS管：英飞凌BSC0805LS，100V耐压，导阻7mΩ。
- 采用**有源钳位反激**（Active Clamp Flyback，ACF）拓扑。[B7]

# 第二篇 理论·技术

## 2.1 开关电源原理概述

电源的本质是**功率变换器**。功率变换器的核心是**DC-DC变换器**（DC-DC converter）。顾名思义，DC-DC变换器可将输入的直流电压转换成另一个直流电压，并将能量从输入端传递到输出端。实际常见的变换器是**AC-DC变换器**，又叫**offline regulator**，它的实质是对输入的交流电进行整流，得到一个较高的直流电压（常称为HVDC，即高压直流电），然后再输入后级DC-DC变换器，变换为所需的直流电压。所谓的“offline”并不是“离线”的意思[B16]，因此这个词不应该翻译成“离线变换器”，而应该翻译成“交流适配器”或者“市电变换器”比较妥当。

基本的DC-DC变换器：**线性变换器**（P4-6）

- 原理：晶体管工作在线性区，充当可调电阻，承受不需要的过剩电压。
- 优点：无噪声，无EMI。
- 缺点：原理决定只能降压；效率低，过剩的电压几乎全部浪费在晶体管上。

改善效率的尝试：**开关式变换器**

- 原理：晶体管工作在开关状态，充当电子开关。（P6）
- 为什么开关式变换器效率高？因为①晶体管导通时，压降V很小，因此损耗VI也较小；②晶体管关断时，无损耗。
- 为什么不使用机械开关？因为机械开关速度慢，体积大，可靠性差，寿命有限。

晶体管比较：

- **BJT**是电流驱动器件，其EMI较小，导通压降为常数，适合大电流。（P7）
- **MOSFET**是电压驱动器件，开关速度快，但是在DC-DC变换器中，N沟道MOSFET所需驱动电压是高于Vin的（实际上是用G-D间的电压来驱动MOS），因此需要**自举电路**产生较高的驱动电压。最简单的自举电路仅由一个电容构成。（P7，B4）
- **IGBT**是电压驱动器件，但是导通压降和开关速度等方面的特性上又与BJT类似，常用于低频、大电流装置，如电力机车。（P7）
- **肖特基二极管**：正向导通压降低（0.5V以下），恢复速度快，但是反向击穿电压较低，漏电流较大且为正温度特性（容易热失控），寄生体电容较大。（P14）

但是，晶体管并非理想开关……

- 晶体管的开关状态转换并非瞬时完成，过渡状态会有损耗，称为**交叉损耗**，或者直接叫**开关损耗**。（P8）
- 折中：若要降低晶体管的正向导通压降以降低导通损耗，可能造成开关转换速度变慢，反而增加交叉损耗。（P8）

引入储能元件以进一步提高效率……

- ① 使用晶体管作为电子开关，而不是可调电阻。晶体管工作在开关模式，损耗较小。（上面已经分析过了）同时，控制开关管的通断时间，就可以控制电路的输出。
- ② 引入输出电容，以保持输出电压稳定，尤其是在开关关断的时刻。
- ③ 引入电阻，以限制电容导致的**浪涌电流**（后文会详细解释）。到这里，就得到了一个RC型开关式DC-DC变换器。（Fig1-2）
- ④ 但是电阻会带来额外的损耗，因此考虑将其替换为电感，同样可以起到抑制浪涌电流的作用。
- ⑤ 引入**续流二极管**（或换流二极管、输出二极管、钳位二极管），就得到了**Buck变换器**。

真的没有任何电阻了吗？元件寄生参数：

- 电抗元件有寄生电阻。例如电感线圈有直流电阻，会导致发热。（P10）
- 电容有等效串联电感（ESL），电感也有寄生电容。

寄生参数是限制开关变换器达到100%效率的首要原因。但是事情不是绝对的：

- 寄生参数可以缓解输出短路时的过流。（P11）
- 寄生电阻的存在可加强系统的稳定性。
- 寄生电感可限制导通瞬间的尖峰电流，但是关断时会产生尖峰电压。
- 寄生电容可限制关断瞬间的尖峰电压，但是导通时会产生尖峰电流。

开关频率是影响开关电源损耗的重要因素。

- 多数损耗（如开关损耗）与开关频率成正相关，因此开关频率越高，电源的效率一般越低。（P12）
- 开关频率越高，EMI问题越严重，甚至会辐射电磁波造成电磁干扰。

但是，开关频率越高，器件的尺寸就可以做得越小。

- 早期LC开关电源的工作频率约15kHz~20kHz，人耳很难听见。（P12）
- 如今已经飙升至MHz级别。

电源的可靠性与温度强相关，因此要做好SMPS的热管理：

- 经验表明，温度每升高10℃，失效率加倍。（P3，P13）
- 温度每升高10℃，铝电解电容的使用寿命减半。（P13）
- 即便是装风扇强制散热，也要考虑风扇的可靠性问题。
- 尽管某些损耗随着温度升高而减少，但是温升同时会影响可靠性。

## 电感和电容

**对偶性质**

||电感(飞轮)|电容(气球)|
|----------------------|
|储能原理|磁场储能(惯性)|电场储能(势能)|
|特性方程|$V = L \cdot \frac{\mathrm d I}{\mathrm d t}$|$I = C \cdot \frac{\mathrm d V}{\mathrm d t}$|
|能量|$E = \frac{1}{2} L I ^ 2$|$E = \frac{1}{2} C V ^ 2$|

**电感的充放电过程**

本节开始构建一个以电感元件为核心的开关变换器电路——Buck-boost电路。首先分析核心元件——电感的充放电特性。

**充电过程**：先考虑RL串联电路，由一电压源$V_{in}$供电。根据KVL和电感特性方程，可以列出微分方程：

$$ V_{in} = IR + L \cdot \frac{\mathrm d I}{\mathrm d t} $$

以开关闭合时为零时刻，此时电流为0。据此解得电感上的充电电流及其变化率为：

$$ I(t) = \frac{V_{in}}{R} (1 - \mathrm{e}^{-(R/L)t}) $$

$$ \frac{\mathrm d}{\mathrm d t}  I(t) = \frac{V_{in}}{L} \mathrm{e}^{-(R/L)t} $$

这意味着，使用RL串联的电路为电感充电，电感上的电流会逐渐增加，最终稳定在$\frac{V_{in}}{R}$。定性地看，这体现了电感的“惯性”，充电开始的一瞬间，电感的反向电动势最大，电流增速减慢，进而导致逆向电动势逐渐减弱，最终电流几乎不变，电感退化为普通的导线。

如果令电阻R等于0，则电感充电电流将以$V_{in} / L$的速率线性上升，直到电感烧毁。

如何用水模型理解这个问题？设想给一个连有飞轮的涡轮两侧施加固定的水压，忽略管路的阻力，那么涡轮和飞轮的转速势必会逐渐增加，越转越快，直至飞轮崩溃。如果管路中有阻力，那么随着水流量的增大，管路阻力会分掉越来越大的水压，而涡轮两侧的压力逐渐减小，直至涡轮不再对水流量的增加产生阻碍，此时水流趋于稳定，外部施加的水压全部作用在管路的阻力上，同时飞轮-涡轮机构储存了一些能量。

**放电过程**：将通有稳定电流的电感元件从电路中切除，电流**将**从非零值瞬间变为零。为了抑制这种趋势，电感两端会产生非常高的反向电动势，形成电弧等现象。

用水模型来解释：一个飞轮-涡轮机构，在稳定的水流中旋转。此时的飞轮-涡轮机构是有惯性的，一旦管路中的水流量有变化，涡轮就会对水流施加压力，阻止流量的变化。假设此时突然关闭阀门，可以想象，由于惯性，飞轮-涡轮机构两端会瞬间产生巨大的水压，冲破管路或者阀门。这又像高速飞行的子弹撞到坚硬的墙上一般，动量（速度）的急剧变化，意味着有强烈的冲量（压力）。

带有惯性的水流在流速突变时冲击管路的现象，实际上非常常见。这称为**水锤效应**。水锤效应危害很大，轻者发出噪音，重者破坏管路。为了减轻水锤效应，可以在管路中设置一种装置叫平压塔。平压塔通过压缩空气等方法，吸收掉水流突变产生的冲击波，从而保护管路。

需要注意的是，实际的物理系统中能量不会突变，因此电感充放电电流并不会突变，但是其导数，也就是感应电动势，是可以突变的。电感放电时电流切断的趋势，促使电感两端**瞬间**形成极高的尖峰电压，进而击穿介质形成回路，将电感中的能量急速消耗掉。尽管这个过程很快，但电流（能量）的消耗是连续的。

## 从电感元件构造升降压拓扑

如何消除电感放电时产生的尖峰电压？解决方案是为电感增加一个**续流回路**。

- 续流回路由一个二极管反向并接在电感两端，这样反向的感应电动势会迫使二极管导通，就不需要产生极高的感应电压以维持一个电弧强行放电了。
- 由于二极管的导通压降是一固定值，根据KVL，电感两端的感应电动势在数值上等于这个固定的压降，因此放电电流是线性下降的，经过足够长的时间，电流下降到0。

### 电感交替充放电·伏秒法则

将电压源$V_{in}$通过开关元件（如MOSFET）连接到一个并接有续流二极管的电感，开关可以交替地导通、关断，以控制电感的充放电。因为电感上并接有续流二极管，所以开关关断时不会产生危险的尖峰电压。

- 开关导通、电感充电时，记此时电感两端的正向电压为$V_{on}$，那么根据上面的分析，电感中的电流$I_L$是线性增加的，增加速率为$V_{on} / L$。如果开关导通时间为$t_{on}$，则充电期间电感电流的增量$\Delta I_{on} = \frac{V_{on} \cdot t_{on}}{L}$。
- 开关关断、电感放电时，记此时电感两端的反向电压为$V_{off}$，那么根据上面的分析，电感中的电流$I_L$是线性下降的，下降速率为$V_{off} / L$。如果开关关断时间为$t_{off}$，则放电期间电感电流的增量$\Delta I_{off} = \frac{V_{off} \cdot t_{off}}{L}$。

从上面的分析可以看到，无论电感中是否已经通有电流，开关的导通和关断，都会导致电感上电流的变化，变化量由电感量L、电感两端的电压以及开关持续时间共同决定。如果电感电路的充放电过程的电流增量始终（在数值上）相等，说明这个电路达到了**稳定状态**。

电感的能量由电感上的电流决定，那么电感电流的增量，实际上就是电感所存储的能量的增量。**电感复位**指的是电感的能量（电流）经过某个充放电过程后又回到初始值，那么，对于一个充放电周期而言，电感复位就是指$\Delta I_{on} = \Delta I_{off}$。**电源稳定工作时，电感在每个充放电周期均复位。**

定量地看，电源稳定工作时，电感在充电和放电阶段的电流增量相等，即

$$ \frac{V_{on} \cdot t_{on}}{L} = \frac{V_{off} \cdot t_{off}}{L} $$

从这个式子可以看出，电源稳定工作的条件就是电感充/放电时的两端电压与充/放电时间的乘积相等，即

$$ V_{on} \cdot t_{on} = V_{off} \cdot t_{off} $$

将电感电压与状态持续时间的乘积称为**伏秒数**。实际上常用μs作为时间单位、μH作为电感单位，在这种语境下的伏秒数称为**伏微秒数**，记作$E_t$。

至此可得**伏秒法则**：电源稳定工作时，电感充放电状态的伏秒数相等，这称为伏秒数平衡。

如果充放电过程的伏秒数不相等，例如充电电流增量大于放电电流增量，那么就无法实现电感复位，电感上的电流就会越来越高，直至烧毁，这就不是“稳定”工作状态了。

电路的伏秒数的决定因素是什么？很明显，充放电时间是因素之一；而电感两端电压这一因素与电路的拓扑和工作模式都有关系。若电路设计和工作模式的选择无法满足伏秒数平衡，那么电路无法稳定工作。

### 开关变换器的工作模式

本节研究**稳定状态下**开关变换器的工作模式。

在开关变换器电路中，开关的交替通断会导致电感上电流的变化，电流的变化量又由充放电阶段的伏秒数决定。需要特别注意的是，开关的通断只会影响电流的增量，因此根据充放电周期开始时刻电感上是否有电流（称为电感“导通”），以及在整个充放电周期中电感上是否始终有电流通过，将开关变换器的工作模式分为以下三种：

- **连续导通模式**（CCM）：稳定状态下，每个充放电周期中，电感中始终有电流通过。CCM是最为常见的工作模式。
- **断续导通模式**（DCM）：稳定状态下，每个充放电周期中，都有一段时间电感无电流通过。
- **临界导通模式**（BCM）：介于CCM和DCM的临界模式。

如果采用同步拓扑，那么还有一种模式

- **强制连续导通模式**（FCCM）

### 使用输出电容从电感中抽取能量

前面讲到，为了消除电感放电时产生的尖峰电压，需要设置续流回路。但是续流二极管的导通压降通常很小，意味着电感两端电压也很小，所以需要较长的放电时间（比充电时间长）才能达到伏秒平衡。另一方面，开关变换器的目的是为了从电感输出能量，而不是将能量白白地浪费在续流回路上。

为了将电感的能量抽取出来，同时促使电路自动进入稳定工作状态，可以在续流回路中设置一个电容。当开关导通时，电源向电感充电；当开关关断时，电感向续流回路释放能量，将能量转移到输出电容上。电路冷启动时，电容上没有能量，两端电压为0，而续流二极管的压降固定，因此电感两端电压等于续流二极管的导通压降，伏秒数较小。此时，电感上的电流经过一次充放电，由于充电伏秒数较大，所以电感上的平均电流逐步增大。随着输出电容被逐渐充电，电压升高，放电时电感两端电压也相应升高，伏秒数随之增加，直至达到伏秒平衡，此时电路进入稳定工作状态，并通过输出电容向外输出能量。

## 三种基本的功率变换器拓扑

**Buck-boost拓扑及其分析**

刚刚构建的开关变换器电路，以储能电感为核心，通过开关进行控制，经续流二极管和输出电容向外输出能量，实际上已经形成了一个基本的开关变换器拓扑，也是最早的开关变换器拓扑：Buck-boost拓扑。

![Buck电路原理图解](./image/assets/Q/SMPS/Buck-operating.png)

![Boost电路原理图解](./image/assets/Q/SMPS/Boost-operating.png)

![Buck-Boost电路原理图解](./image/assets/Q/SMPS/Buck-boost-operating.png)

## 反激式拓扑

![基本的反激式变换器拓扑 输出电压波形仿真](./image/assets/Q/SMPS/flyback-simulation.png)

### 有源钳位反激拓扑

简单来说，ACF拓扑优点很多，它元件少、天生AC-DC隔离、效率高，但前提是必须有精确的控制。因此当德仪推出ACF控制器方案之后，就可以大规模使用了。

![有源钳位反激](./image/assets/Q/SMPS/有源钳位反激.png)

![UCC28780控制器简化应用电路\[A7\]](./image/assets/Q/SMPS/UCC28780-Schematic.png)

![UCC28780控制器+氮化镓功率管典型电路\[A7\]](./image/assets/Q/SMPS/UCC28780-GaN.png)

![高密度GaN充电器参考设计\[A8\]](./image/assets/Q/SMPS/高密度GaN充电器参考设计.png)

## 损耗分析

## 反馈环路分析

## 安全·热设计

## EMI抑制

# 第三篇 仿真·实验

## Buck-boost 仿真

![Buck-Boost仿真电路，负载100Ω](./image/assets/Q/SMPS/Buck-boost-simulation.png)

![占空比20%，上为开关节点电压，下为电感电流](./image/assets/Q/SMPS/Buck-boost-waveform-1.png)

输出电压、工作模式（CCM/DCM）受负载影响。

# 第四篇 指南·参考

以下是教材、论文、胶片、数据表和专著：

- A1 / Sanjaya Maniktala. **精通开关电源设计**（第二版）[M]. 2015.
- A2 / 周洁敏. **开关电源理论及设计**[M]. 北京航空航天大学出版社, 2012.
- A3 / 长谷川 彰. **开关稳压电源的设计与应用**[M]. 科学出版社. 2006.
- A4 / Paul Scherz, Simon Monk. **实用电子元器件与电路基础（第四版）**[M]. 电子工业出版社, 2017.
- A5 / Charles K Alexander等. **电路基础（第5版）**[M]. 机械工业出版社. 2014.
- A6-B6 / Xue L , Zhang J . **Active Clamp Flyback Using GaN Power IC for Power Adapter Applications**[S]. IEEE 2017 Applied Power Electronics Conference & Exposition. IEEE, 2017:2441-2448.
- A7 / [UCC28780 Datasheet](http://www.ti.com/lit/ds/slusd12a/slusd12a.pdf)
- A8 / [30-W/in3, 94% Efficiency, 65-W USB Type-C PD AC/DC Adapter Reference Design](http://www.ti.com/lit/ug/tidudw2b/tidudw2b.pdf)

以下是来自网络的资料，如维基百科、博客文章、视频等：

- B1 / [维基百科：降压变换器](https://zh.wikipedia.org/wiki/%E9%99%8D%E5%8E%8B%E5%8F%98%E6%8D%A2%E5%99%A8)
- B2 / [维基百科：升压变换器](https://zh.wikipedia.org/wiki/%E5%8D%87%E5%A3%93%E8%AE%8A%E6%8F%9B%E5%99%A8)
- B3 / [维基百科：降压-升压变换器](https://zh.wikipedia.org/wiki/%E9%99%8D%E5%A3%93-%E5%8D%87%E5%A3%93%E8%AE%8A%E6%8F%9B%E5%99%A8)
- B4 / [B站视频：手机充电器原理1-升降压拓扑](https://www.bilibili.com/video/av89136039)
- B5 / [小米65W氮化镓充电器拆解报告](http://www.chongdiantou.com/wp/archives/46552.html)
- B6 / [截至2017年高密度开关电源的发展-泡瓦伊莱超尼克斯的回答](https://www.zhihu.com/question/20517480/answer/237857229)
- B7-B6 / [仅重60克！史上最小Type-C手提电脑适配器面世](https://www.eet-china.com/news/201709261540.html)
- B8 / [关于小米那款65W氮化镓充电器](https://www.eet-china.com/news/8252.html)
- B9 / [有源钳位反激，电源适配器的下一个演进](https://www.eefocus.com/aliyan/blog/18-11/433906_ea58f.html)
- B10 / [有源钳位反激式方案，了解一下](https://mp.weixin.qq.com/s?__biz=MzU3OTA0MjQ3Mg==&mid=2247505978&idx=6&sn=2b6a85796a017220c522ec1c22cd876a)
- B11 / [The Active Clamp Flyback Converter: A Design Whose Time Has Come](https://www.electronicdesign.com/power-management/article/21806372/the-active-clamp-flyback-converter-a-design-whose-time-has-come)
- B12 / [What is active clamp flyback?](https://training.ti.com/what-active-clamp-flyback?HQS=app-hvp-hvc-activeclampflyback-asset-tr-ElectronicDesign-wwe&DCM=yes)（视频）
- B13 / [Running cool and fast with the active clamp flyback](https://www.electronicproducts.com/Power_Products/Power_and_Control/Running_cool_and_fast_with_the_active_clamp_flyback.aspx)
- B14 / [GaN Based 25W Adapter with Active Clamp Flyback Topology for Speaker System](https://www.youtube.com/watch?v=yfoT8XQKKi8)
- B15 / [Understanding the Basics of a Flyback Converter](https://training.ti.com/understanding-basics-flyback-converter?HQS=app-hvp-hvc-activeclampflyback-asset-tr-null-wwe&DCM=yes)（视频）
- B16 / [维基百科：off line regulator](https://en.wikipedia.org/wiki/Off_line_regulator)

题图：[ダムの音色](https://www.pixiv.net/artworks/71334405)
